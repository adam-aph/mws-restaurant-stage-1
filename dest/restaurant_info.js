class DBHelper{static get PORT(){return 1337}static get DATABASE_URL(){return`http://localhost:${DBHelper.PORT}/restaurants`}static getDatabaseUrlOne(e){return`http://localhost:${DBHelper.PORT}/restaurants/${e}`}static getDatabaseUrlOneReviews(e){return`http://localhost:${DBHelper.PORT}/reviews/?restaurant_id=${e}`}static get DATABASE_GET_ALL_FAVORITES(){return`http://localhost:${DBHelper.PORT}/restaurants/?is_favorite=true`}static get DATABASE_SUBMIT_REVIEW(){return`http://localhost:${DBHelper.PORT}/reviews`}static setDatabaseUrlOneFavorite(e,t){return`http://localhost:${DBHelper.PORT}/restaurants/${e}/?is_favorite=${t}`}static fetchRestaurants(e){let t=new XMLHttpRequest;t.open("GET",DBHelper.DATABASE_URL),t.onload=(()=>{if(200===t.status){const n=JSON.parse(t.responseText);e(null,n)}else{const n=`Request failed. Returned status of ${t.status}`;e(n,null)}}),t.send()}static fetchOneRestaurant(e,t){let n=new XMLHttpRequest;n.open("GET",DBHelper.getDatabaseUrlOne(e)),n.onload=(()=>{if(200===n.status){const e=JSON.parse(n.responseText);e?t(null,e):t("Restaurant does not exist",null)}else{const e=`Request failed. Returned status of ${n.status}`;t(e,null)}}),n.send()}static fetchOneRestaurantReviews(e,t){let n=new XMLHttpRequest;n.open("GET",DBHelper.getDatabaseUrlOneReviews(e)),n.onload=(()=>{if(200===n.status){const e=JSON.parse(n.responseText);e?t(null,e):t("Reviews do not exist",null)}else{const e=`Request failed. Returned status of ${n.status}`;t(e,null)}}),n.send()}static fetchRestaurantByCuisine(e,t){DBHelper.fetchRestaurants((n,r)=>{if(n)t(n,null);else{const n=r.filter(t=>t.cuisine_type==e);t(null,n)}})}static fetchRestaurantByNeighborhood(e,t){DBHelper.fetchRestaurants((n,r)=>{if(n)t(n,null);else{const n=r.filter(t=>t.neighborhood==e);t(null,n)}})}static fetchRestaurantByCuisineAndNeighborhood(e,t,n){DBHelper.fetchRestaurants((r,a)=>{if(r)n(r,null);else{let r=a;"all"!=e&&(r=r.filter(t=>t.cuisine_type==e)),"all"!=t&&(r=r.filter(e=>e.neighborhood==t)),n(null,r)}})}static fetchNeighborhoods(e){DBHelper.fetchRestaurants((t,n)=>{if(t)e(t,null);else{const t=n.map((e,t)=>n[t].neighborhood),r=t.filter((e,n)=>t.indexOf(e)==n);e(null,r)}})}static fetchCuisines(e){DBHelper.fetchRestaurants((t,n)=>{if(t)e(t,null);else{const t=n.map((e,t)=>n[t].cuisine_type),r=t.filter((e,n)=>t.indexOf(e)==n);e(null,r)}})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static imageSrcSetUrlForRestaurant(e){return`/img2/${e.id}`+"-300_small.webp 300w, "+`/img/${e.id}`+".webp 600w"}static imageSizesUrlForRestaurant(e){return"(max-width: 400px) 300px, 600px"}static imageSrcUrlForRestaurant(e){return`/img2/${e.id}`+"-300_small.webp"}static imageAltDescForRestaurant(e){return`Restaurant: ${e.name} of ${e.cuisine_type} cuisine type`}static mapMarkerForRestaurant(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:DBHelper.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}}let restaurant;var map;function check_empty(){let e=document.getElementById("name").value,t=document.getElementById("rating").value,n=document.getElementById("msg").value,r=document.getElementById("favorite").checked;""==e||""==t||""==n?alert("Fill All Fields !"):t<1||t>6?alert("Rating: 1-6 !"):(submit_form(e,t,n,r),div_hide())}function div_show(){document.getElementById("name").value="",document.getElementById("favorite").checked="true"===self.restaurant.is_favorite,document.getElementById("rating").value="",document.getElementById("msg").value="",document.getElementById("reviewform").style.display="block",document.getElementById("name").focus()}function div_hide(){document.getElementById("reviewform").style.display="none"}function escapeUnicode(e){return e.replace(/[^\0-~]/g,function(e){return"&#x"+("0000"+e.charCodeAt().toString(16)).slice(-4)+";"})}function generateUUID(){var e=(new Date).getTime();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)})}function sendMessageToSW(e){return new Promise(function(t,n){var r=new MessageChannel;r.port1.onmessage=function(e){e.data.error?n(e.data.error):t(e.data)},navigator.serviceWorker.controller.postMessage(e,[r.port2])})}function sendPostponedMsg(e,t,n,r){const a=generateUUID();addReviewsHTMLOffline(t,n,r,a),console.log("New sendPostponedMsg uuid: "+a),sendMessageToSW({type:"review",uuid:a,url:DBHelper.DATABASE_SUBMIT_REVIEW,options:{method:"POST",headers:{"Content-Type":"application/json;charset=UTF-8"},body:{restaurant_id:e,name:t,rating:n,comments:r}}}).then(function(e){console.log("Updating updateReviewsHTMLOffline response: "+JSON.stringify(e)),updateReviewsHTMLOffline(t,n,r,a,e.updatedAt)}).catch(function(e){console.log(e)})}function sendPostponedFavMsg(e,t){const n=generateUUID();console.log("New sendPostponedFavMsg uuid: "+n),sendMessageToSW({type:"favorite",uuid:n,url:DBHelper.setDatabaseUrlOneFavorite(e,t),options:{method:"POST",headers:{"Content-Type":"application/json;charset=UTF-8"}}}).then(function(e){console.log("Updating updateRestaurantTitleHTML response: "+JSON.stringify(e)),updateRestaurantTitleHTML(t)}).catch(function(e){console.log(e)})}function submit_review(e,t,n,r){let a=new XMLHttpRequest;a.open("POST",DBHelper.DATABASE_SUBMIT_REVIEW),a.setRequestHeader("Content-Type","application/json;charset=UTF-8"),a.onload=(()=>{if(200===a.status||201===a.status){var s=JSON.parse(a.responseText);addReviewsHTML(s),DBHelper.fetchOneRestaurantReviews(e,(e,t)=>{self.restaurant.reviews=t})}else alert("Submit Error: "+a.status+"\nYour review will be re-submitted automatically later"),sendPostponedMsg(e,t,n,r)}),a.onerror=(()=>{alert("Submit Error: "+a.status+"\nYour review will be re-submitted automatically later"),sendPostponedMsg(e,t,n,r)}),a.send(JSON.stringify({restaurant_id:e,name:t,rating:n,comments:r}))}function submit_favorite(e,t){let n=new XMLHttpRequest;n.open("POST",DBHelper.setDatabaseUrlOneFavorite(e,t)),n.setRequestHeader("Content-Type","application/json;charset=UTF-8"),n.onload=(()=>{200===n.status||201===n.status?DBHelper.fetchOneRestaurant(e,(e,n)=>{self.restaurant=n,n?updateRestaurantTitleHTML(t):console.error(e)}):sendPostponedFavMsg(e,t)}),n.onerror=(()=>{sendPostponedFavMsg(e,t)}),n.send()}function submit_form(e,t,n,r){const a=getParameterByName("id");submit_review(a,e,t,n),r!=("true"===self.restaurant.is_favorite)&&submit_favorite(a,r)}window.initMap=(()=>{fetchRestaurantFromURL((e,t)=>{e?console.error(e):(self.map=new google.maps.Map(document.getElementById("map"),{zoom:16,center:t.latlng,scrollwheel:!1}),fillBreadcrumb(),document.getElementById("map").style.display="inline",DBHelper.mapMarkerForRestaurant(self.restaurant,self.map),self.map.addListener("tilesloaded",function(){var e=document.querySelectorAll("#map a");[].forEach.call(e,function(e){e.setAttribute("tabindex","-1")})}))})}),fetchRestaurantFromURL=(e=>{if(self.restaurant)return void e(null,self.restaurant);const t=getParameterByName("id");t?DBHelper.fetchOneRestaurant(t,(n,r)=>{self.restaurant=r,r?(fillRestaurantHTML(),e(null,r),DBHelper.fetchOneRestaurantReviews(t,(e,t)=>{self.restaurant.reviews=t,fillReviewsHTML()})):console.error(n)}):(error="No restaurant id in URL",e(error,null))}),fillRestaurantHTML=((e=self.restaurant)=>{const t=document.getElementById("restaurant-name");t.setAttribute("tabindex","0"),t.innerHTML=e.name+"&emsp;&emsp;&emsp;&emsp;&emsp;"+("true"===e.is_favorite?"[Favorite]":"[Not favorite]");const n=document.getElementById("restaurant-address");n.setAttribute("tabindex","0"),n.innerHTML=e.address;const r=document.getElementById("restaurant-img");r.className="restaurant-img",r.srcset=DBHelper.imageSrcSetUrlForRestaurant(e),r.sizes=DBHelper.imageSizesUrlForRestaurant(e),r.src=DBHelper.imageSrcUrlForRestaurant(e),r.alt=DBHelper.imageAltDescForRestaurant(e),document.getElementById("restaurant-cuisine").innerHTML=e.cuisine_type,e.operating_hours&&fillRestaurantHoursHTML()}),updateRestaurantTitleHTML=(e=>{const t=document.getElementById("restaurant-name"),n=self.restaurant;t.innerHTML=n.name+"&emsp;&emsp;&emsp;&emsp;&emsp;"+("true"===n.is_favorite?"[Favorite]":"[Not favorite]")}),fillRestaurantHoursHTML=((e=self.restaurant.operating_hours)=>{const t=document.getElementById("restaurant-hours");t.setAttribute("tabindex","0");for(let n in e){const r=document.createElement("tr"),a=document.createElement("td");a.innerHTML=n,r.appendChild(a);const s=document.createElement("td");s.innerHTML=e[n],r.appendChild(s),t.appendChild(r)}}),fillReviewsHTML=((e=self.restaurant.reviews)=>{const t=document.getElementById("reviews-container"),n=document.createElement("h4");n.innerHTML="Reviews";const r=document.createElement("a");if(r.innerHTML="Add Review",r.href="javascript:%20div_show()",r.setAttribute("aria-label","add review"),r.setAttribute("role","button"),r.setAttribute("tabindex","0"),n.append(r),t.appendChild(n),!e){const e=document.createElement("p");return e.innerHTML="No reviews yet!",void t.appendChild(e)}const a=document.getElementById("reviews-list");e.forEach(e=>{a.appendChild(createReviewHTML(null,e))}),t.appendChild(a)}),addReviewsHTMLOffline=((e,t,n,r)=>{document.getElementById("reviews-list").insertBefore(createReviewHTML(null,{name:e,rating:t,comments:n,updatedAt:0,uuid:r}),null)}),addReviewsHTML=(e=>{document.getElementById("reviews-list").insertBefore(createReviewHTML(null,e),null)}),updateReviewsHTMLOffline=((e,t,n,r,a)=>{console.log("Updating uuid: "+r);for(var s=document.getElementById("reviews-list").getElementsByTagName("li"),i=0;i<s.length;++i)s[i].getAttribute("uuid")==r&&createReviewHTML(s[i],{name:e,rating:t,comments:n,updatedAt:a})}),createReviewHTML=((e,t)=>{var n=e;if(null==e)n=document.createElement("li");else for(;n.firstChild;)n.removeChild(n.firstChild);n.setAttribute("tabindex","0"),t.hasOwnProperty("uuid")&&n.setAttribute("uuid",t.uuid);const r=document.createElement("p");r.innerHTML=t.name,n.appendChild(r);const a=document.createElement("p");0!=t.updatedAt?(dateTime=new Date(t.updatedAt),a.innerHTML=dateTime.toString()):a.innerHTML="Not yet updated at the Server",n.appendChild(a);const s=document.createElement("p");s.innerHTML=`Rating: ${t.rating}`,n.appendChild(s);const i=document.createElement("p");return i.innerHTML=escapeUnicode(t.comments),n.appendChild(i),n}),fillBreadcrumb=((e=self.restaurant)=>{const t=document.getElementById("breadcrumb");t.setAttribute("aria-label","breadcrumb"),t.setAttribute("role","navigation");const n=document.createElement("li");n.innerHTML=e.name,t.appendChild(n)}),getParameterByName=((e,t)=>{t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");const n=new RegExp(`[?&]${e}(=([^&#]*)|&|#|$)`).exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null});